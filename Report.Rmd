---
title: "OAS Treasurer's Report"
author: "David Barron"
date: "`r Sys.Date()`"
output:
  html_document: default
---

---
title: "Treasurer's Report"
author: "David Barron"
date: "`r format(Sys.Date(), '%d %B %Y' )`"
output:
  html_document: default
---

```{r setup, include=FALSE}
library(knitr)
library(kableExtra)

opts_chunk$set(echo = FALSE)
options(knitr.kable.NA = '')

inline_hook <- function(x){
  
  format(x, nsmall = 2, scientific = FALSE, big.mark = ",")
  
  
}

knit_hooks$set(inline = inline_hook)


```

```{r intro, echo=FALSE, message=FALSE}
library(readxl)
library(tidyverse)

year <- 2024

months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep",
           "Oct", "Nov", "Dec")
```

```{r data, echo=FALSE, message=FALSE}

fn <- paste0("C:\\Users\\dnbar\\Dropbox\\OAS\\", year, "\\OAS ", year, ".xlsx")

dta <- read_xlsx(fn,
                 sheet = "Current account") %>%
        filter(Category != "Transfer Out") %>%
        filter(Category != "Transfer In")

savings.dta <- read_xlsx(fn,
                 sheet = "Savings account")  %>%
        filter(Category != "Transfer Out") %>%
        filter(Category != "Transfer In") 

                 
nrows <- nrow(dta)


dta.sum <- dta %>%
          mutate(Date = lubridate::ymd(Date),
                 Month = lubridate::month(Date)) %>%
        group_by(Month) %>%
        summarise(
         Expend = sum(Expenditure, na.rm = TRUE),
         Inc = sum(Income, na.rm = TRUE)
        ) 

savings.dta.sum <- savings.dta %>%
          mutate(Date = lubridate::ymd(Date),
                 Month = lubridate::month(Date)) %>%
        group_by(Month) %>%
        summarise(
         Expend = sum(Expenditure, na.rm = TRUE),
         Inc = sum(Income, na.rm = TRUE)
        ) 
  
dta.cumsum <-  dta.sum %>%
    mutate(
          Income = cumsum(Inc),
          Expenditure = cumsum(Expend)
        ) %>%
        select(Month, Income, Expenditure)

num.months <- dim(dta.cumsum)[1]

savings.dta.cumsum <-  savings.dta.sum %>%
    mutate(
          Income = cumsum(Inc),
          Expenditure = cumsum(Expend)
        ) %>%
        select(Month, Income, Expenditure)

dta.long <- dta.cumsum %>% pivot_longer(
              cols = Income:Expenditure,
              names_to = "Type",
              values_to = "Amount"
              ) 
  
savings.dta.long <- dta.cumsum %>% pivot_longer(
              cols = Income:Expenditure,
              names_to = "Type",
              values_to = "Amount"
              ) 

total.dta.long <- dta.long
total.dta.long[, "Amount"] <- total.dta.long[,"Amount"] +    savings.dta.long[,"Amount"]

nrow.savings <- nrow(savings.dta)
savings.balance <- as.numeric(savings.dta[nrow.savings,6])

sum_tab <- dta %>%
  group_by(Category) %>%
  summarise(Income = sum(Income, na.rm = TRUE),
            Expenditure = sum(Expenditure, na.rm = TRUE))


savings.sum_tab <- savings.dta %>%
  group_by(Category) %>%
  summarise(Income = sum(Income, na.rm = TRUE),
            Expenditure = sum(Expenditure, na.rm = TRUE))

total.income <- as.numeric(dta.cumsum[num.months, 2]) + as.numeric(savings.dta.cumsum[num.months, 2]) 

total.expenditure <- as.numeric(dta.cumsum[num.months, 3]) + as.numeric(savings.dta.cumsum[num.months, 3]) 


```

```{r plot, echo=FALSE}



all.months <- months[1:12]
labels = all.months[1:num.months]


total.dta.long  %>%
  ggplot(aes(x = Month, y = Amount, colour = Type)) + 
          geom_point() +
          geom_line() +
          scale_x_continuous(
            breaks = 1:12,
            minor_breaks = NULL,
            label =  all.months
          ) + 
  scale_y_continuous(label = scales::label_dollar(prefix="£")) +
  theme_light() 


```


## Income and Expenditure

- Total income since 1 January 2024 is £`r total.income`

- Total expenditure since 1 January 2024 is £`r total.expenditure`

- **The current year's `r ifelse(total.income - total.expenditure > 0, "surplus", "deficit")` is £`r total.income - total.expenditure`**.

- Current bank balance £`r as.numeric(dta[nrows,6]) `

- Savings account balance £`r savings.balance`


```{r summary, eval=TRUE}
sum_tab <- bind_rows(sum_tab, savings.sum_tab)

sum_tab %>% kbl() %>%
  kable_classic(full_width = FALSE)

```
